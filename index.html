<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro Cam Meter - Fixed View</title>
    <style>
        :root { --accent: #00ffcc; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; overflow: hidden; font-family: sans-serif; }
        
        /* 1. 背景影片全螢幕 */
        #video {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%; object-fit: cover; z-index: 1;
        }

        /* 2. 快門簾 (平時移到畫面外) */
        .shutter {
            position: absolute; left: 0; width: 100%; height: 50%;
            background: #000; z-index: 100; transition: transform 0.2s ease;
        }
        #shutter-top { top: 0; transform: translateY(-100%); }
        #shutter-bottom { bottom: 0; transform: translateY(100%); }
        .shutter.active { transform: translateY(0); }

        /* 3. 懸浮 UI 層 */
        .ui-overlay {
            position: absolute; bottom: 0; left: 0; width: 100%;
            z-index: 50; padding-bottom: 30px;
            background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, transparent 100%);
        }

        .display-row {
            display: flex; justify-content: space-around; padding: 20px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        }

        .box { text-align: center; }
        .label { font-size: 0.7rem; color: #ccc; margin-bottom: 4px; text-transform: uppercase; }
        .val { font-size: 1.4rem; color: var(--accent); font-weight: bold; font-family: monospace; }

        .btn-container { text-align: center; margin-top: 10px; }
        #shutter-trigger {
            width: 65px; height: 65px; border-radius: 50%; border: 4px solid #fff;
            background: rgba(255,255,255,0.3); box-shadow: 0 0 15px rgba(0,0,0,0.5);
        }
        #shutter-trigger.locked { border-color: var(--accent); background: rgba(0, 255, 204, 0.3); }

        #ev-tag {
            position: absolute; top: 20px; left: 20px; z-index: 50;
            background: rgba(0,0,0,0.5); padding: 4px 10px; border-radius: 4px; font-size: 0.8rem; color: #eee;
        }
    </style>
</head>
<body>

    <video id="video" autoplay playsinline></video>
    
    <div id="shutter-top" class="shutter"></div>
    <div id="shutter-bottom" class="shutter"></div>

    <div id="ev-tag">ENV: <span id="ev-val">--</span> EV</div>

    <div class="ui-overlay">
        <div class="display-row">
            <div class="box">
                <div class="label">Aperture</div>
                <div class="val" id="res-f">--</div>
            </div>
            <div class="box">
                <div class="label">Shutter</div>
                <div class="val" id="res-s">--</div>
            </div>
            <div class="box">
                <div class="label">ISO</div>
                <div class="val" id="res-iso">--</div>
            </div>
        </div>

        <div class="btn-container">
            <button id="shutter-trigger" onclick="triggerShutter()"></button>
        </div>
    </div>

    <canvas id="calcCanvas" style="display:none;"></canvas>

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('calcCanvas');
    const ctx = canvas.getContext('2d');
    const sTop = document.getElementById('shutter-top');
    const sBottom = document.getElementById('shutter-bottom');
    const btn = document.getElementById('shutter-trigger');

    let isLocked = false;
    let updateInterval;

    async function init() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment" },
                audio: false 
            });
            video.srcObject = stream;
            startMetering();
        } catch (e) { alert("請檢查相機權限"); }
    }

    function startMetering() {
        updateInterval = setInterval(analyze, 500);
    }

    function triggerShutter() {
        sTop.classList.add('active');
        sBottom.classList.add('active');

        setTimeout(() => {
            sTop.classList.remove('active');
            sBottom.classList.remove('active');
            
            isLocked = !isLocked;
            if (isLocked) {
                clearInterval(updateInterval);
                btn.classList.add('locked');
            } else {
                startMetering();
                btn.classList.remove('locked');
            }
        }, 250);
    }

    function analyze() {
        if (!video.videoWidth || isLocked) return;
        canvas.width = 40; canvas.height = 40;
        ctx.drawImage(video, 0, 0, 40, 40);
        const data = ctx.getImageData(0,0,40,40).data;
        let bright = 0;
        for(let i=0; i<data.length; i+=4) bright += (data[i]*0.299 + data[i+1]*0.587 + data[i+2]*0.114);
        const avg = bright / 1600;
        
        // 修正測光敏感度
        const ev = Math.max(1, Math.min(17, Math.round((avg / 255) * 12 + 3)));
        document.getElementById('ev-val').innerText = ev;
        calculate(ev);
    }

    function calculate(ev) {
        let f = 2.8, iso = 100;
        let s = Math.pow(f, 2) / (Math.pow(2, ev));

        if (s > 1/60) {
            s = 1/60;
            iso = Math.round((f*f * 100) / (s * Math.pow(2, ev)));
        }

        iso = Math.max(100, Math.round(iso/100)*100);
        let sStr = s < 1 ? `1/${Math.round(1/s)}` : `${s.toFixed(1)}s`;
        
        document.getElementById('res-f').innerText = `f/${f}`;
        document.getElementById('res-s').innerText = sStr;
        document.getElementById('res-iso').innerText = iso;
    }

    init();
</script>
</body>
</html>
