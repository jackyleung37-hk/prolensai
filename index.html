<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Cam Meter v2</title>
    <style>
        :root { --accent: #00ffcc; --bg: #0a0a0a; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; background: var(--bg); color: #fff; }
        #camera-wrapper { position: relative; width: 100vw; height: 100vh; display: flex; flex-direction: column; }
        video { width: 100%; height: 60%; object-fit: cover; border-bottom: 2px solid #333; }
        
        .controls {
            flex: 1; padding: 20px; display: flex; flex-direction: column; gap: 15px;
            background: linear-gradient(0deg, #000 0%, #1a1a1a 100%);
        }

        .mode-selector { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; }
        .mode-btn {
            padding: 8px 15px; border-radius: 20px; border: 1px solid #444;
            background: #222; color: #888; white-space: nowrap; font-size: 0.8rem;
        }
        .mode-btn.active { background: var(--accent); color: #000; border-color: var(--accent); font-weight: bold; }

        .display-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; text-align: center; }
        .box { background: rgba(255,255,255,0.05); padding: 15px 5px; border-radius: 10px; border: 1px solid #333; }
        .label { font-size: 0.7rem; color: #888; margin-bottom: 5px; }
        .val { font-size: 1.1rem; font-family: 'Courier New', monospace; font-weight: bold; color: var(--accent); }
        
        #ev-tag { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.6); padding: 5px 10px; border-radius: 5px; font-size: 0.8rem; }
    </style>
</head>
<body>

<div id="camera-wrapper">
    <video id="video" autoplay playsinline></video>
    <div id="ev-tag">EV <span id="ev-val">--</span></div>
    <canvas id="calcCanvas" style="display:none;"></canvas>

    <div class="controls">
        <div class="mode-selector">
            <button class="mode-btn active" onclick="setMode('auto', this)">自動平衡</button>
            <button class="mode-btn" onclick="setMode('sports', this)">運動優先</button>
            <button class="mode-btn" onclick="setMode('portrait', this)">人像大光圈</button>
            <button class="mode-btn" onclick="setMode('landscape', this)">風景深</button>
        </div>

        <div class="display-grid">
            <div class="box">
                <div class="label">光圈 (F)</div>
                <div class="val" id="res-f">--</div>
            </div>
            <div class="box">
                <div class="label">快門 (S)</div>
                <div class="val" id="res-s">--</div>
            </div>
            <div class="box">
                <div class="label">感光度 (ISO)</div>
                <div class="val" id="res-iso">--</div>
            </div>
        </div>
        
        <div style="font-size: 0.7rem; color: #444; text-align: center;">
            請確保環境光線穩定，數據僅供專業相機設定參考
        </div>
    </div>
</div>

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('calcCanvas');
    const ctx = canvas.getContext('2d');
    let currentMode = 'auto';
    let currentEV = 10;

    async function init() {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        video.srcObject = stream;
        setInterval(analyze, 400);
    }

    function setMode(mode, btn) {
        currentMode = mode;
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        calculate(currentEV);
    }

    function analyze() {
        if (!video.videoWidth) return;
        canvas.width = 40; canvas.height = 40;
        ctx.drawImage(video, 0, 0, 40, 40);
        const data = ctx.getImageData(0,0,40,40).data;
        let bright = 0;
        for(let i=0; i<data.length; i+=4) bright += (data[i]*0.299 + data[i+1]*0.587 + data[i+2]*0.114);
        const avg = bright / 1600;
        currentEV = Math.max(1, Math.min(18, Math.round((avg / 255) * 14 + 2)));
        document.getElementById('ev-val').innerText = currentEV;
        calculate(currentEV);
    }

    function calculate(ev) {
        let f = 2.8, s = 1/125, iso = 100;

        if (currentMode === 'sports') {
            s = 1/500;
            f = 2.8;
            // ISO = (N^2 * 100) / (t * 2^EV)
            iso = Math.round((f*f * 100) / (s * Math.pow(2, ev)));
        } 
        else if (currentMode === 'portrait') {
            f = 1.8;
            s = Math.max(1/1000, Math.pow(f, 2) / (Math.pow(2, ev)));
            iso = (s < 1/1000) ? Math.round((f*f * 100) / (s * Math.pow(2, ev))) : 100;
        }
        else if (currentMode === 'landscape') {
            f = 11;
            iso = 100;
            s = Math.pow(f, 2) / (Math.pow(2, ev));
        }
        else { // Auto
            f = 4.0;
            s = Math.pow(f, 2) / (Math.pow(2, ev));
            if (s > 1/60) { s = 1/60; iso = Math.round((f*f * 100) / (s * Math.pow(2, ev))); }
        }

        // 格式化輸出
        iso = Math.max(100, Math.round(iso/100)*100);
        let sStr = s < 1 ? `1/${Math.round(1/s)}` : `${s.toFixed(1)}"`;
        
        document.getElementById('res-f').innerText = `f/${f}`;
        document.getElementById('res-s').innerText = sStr;
        document.getElementById('res-iso').innerText = iso;
    }

    init();
</script>
</body>
</html>
